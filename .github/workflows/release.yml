name: release

on:
  push:
    branches: 
      - master

jobs:

  release:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11

    - name: Parse Version from POM
      shell: bash
      run: |
        cat pom.xml | grep version -m 2 | tail -1 | awk '{$1=$1};1' | awk -F'>' '{print $2}' | awk -F'<' '{print $1}' > /tmp/version.txt
    - name: Print version
      shell: bash
      run: |
        version=`cat /tmp/version.txt` && echo Deploying $version
    - name: Release package
      run: |
        version=`cat /tmp/version.txt` &&
        curl -X POST \
          https://api.github.com/repos/whelk-io/spring-boot-starter-data-logging/releases \
          -H 'Authorization: Bearer ${{ secrets.BUILD_TOKEN }}' \
          -H 'Content-Type: application/json' \
          -H 'Host: api.github.com' \
          -d '{ "tag_name": "'$version'", "target_commitish": "master", "name": "'$version'", "body": "Release deployment", "draft": false, "prerelease": false }'

    - name: Create Maven settings.xml
      uses: whelk-io/maven-settings-xml-action@v2
      with:
        servers: '[{"id": "github-spring-boot-starter-data-logging", "username": "${{ secrets.BUILD_USERNAME }}", "password": "${{ secrets.BUILD_TOKEN }}"}]'

    - name: Deploy package
      run: mvn -B deploy --file pom.xml

    - name: Merge master to develop
      run: |
        git fetch
        git checkout develop
        git config --local user.email ${{ secrets.BUILD_EMAIL }}
        git config --local user.name ${{ secrets.BUILD_USERNAME }}
        git pull
        git merge origin/master
        git push